"use strict";var GeneExpressionApp=(()=>{var S=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var De=Object.getOwnPropertyNames;var Ge=Object.prototype.hasOwnProperty;var Ne=(t,e)=>{for(var n in e)S(t,n,{get:e[n],enumerable:!0})},Me=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of De(e))!Ge.call(t,s)&&s!==n&&S(t,s,{get:()=>e[s],enumerable:!(r=Se(e,s))||r.enumerable});return t};var Pe=t=>Me(S({},"__esModule",{value:!0}),t);var tt={};Ne(tt,{App:()=>E});function F(t){let e=t.trim().split(/\r?\n/);if(e.length<3)throw new Error("Invalid file format: File must have at least 3 rows (title, headers, data)");let n=e[0].trim(),r=e[1].split("	").map(o=>o.trim()),s=[];for(let o=2;o<e.length;o++){let a=e[o].trim();if(!a)continue;let l=a.split("	"),i={};r.forEach((d,m)=>{i[d]=l[m]?.trim()??""}),s.push(i)}return{title:n,headers:r,rows:s}}function O(t){let e=[];return t.headers.includes("Name")||e.push({field:"headers",message:'Missing required "Name" column in data'}),!t.headers.some(r=>r.toLowerCase().includes("ct")||t.rows.some(s=>!isNaN(parseFloat(s[r]))))&&t.headers.length<2&&e.push({field:"headers",message:"Data must contain CT value columns"}),t.rows.length===0&&e.push({field:"rows",message:"No data rows found in file"}),{isValid:e.length===0,errors:e}}function B(t){let e="Name",n=new Set;return t.rows.forEach(r=>{let s=r[e];s&&s.trim()&&!R(r)&&n.add(s.trim())}),Array.from(n)}function R(t){let e=t.Name??"";return/^Sample\s*\d+$/i.test(e.trim())}function w(t){return{...t,rows:t.rows.filter(e=>!R(e))}}function A(t,e){return t.rows.filter(n=>n.Name===e&&!R(n))}function z(t){let e="Status",n=new Set;return t.rows.forEach(r=>{let s=r[e]?.trim();s&&s.length>0&&n.add(s)}),Array.from(n)}function q(t){let e=["cp","ct","cq"];for(let n of e){let r=t.headers.find(s=>s.toLowerCase()===n);if(r)return r}for(let n of e){let r=t.headers.find(s=>s.toLowerCase().includes(n));if(r)return r}for(let n of t.headers){if(n==="Name")continue;if(t.rows.some(s=>{let o=s[n];if(!o)return!1;let a=parseFloat(o);return!isNaN(a)&&a>0&&o.includes(".")}))return n}return null}async function Le(t){try{if(!Ve(t))return{success:!1,error:"Invalid file type. Please select a .txt or .tsv file."};let e=await ke(t),n=F(e),r=O(n);return r.isValid?{success:!0,data:n}:{success:!1,error:r.errors.map(s=>s.message).join("; ")}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error processing file"}}}function ke(t){return new Promise((e,n)=>{let r=new FileReader;r.onload=s=>{let o=s.target?.result;typeof o=="string"?e(o):n(new Error("Failed to read file content"))},r.onerror=()=>{n(new Error("Error reading file"))},r.readAsText(t)})}function Ve(t){let e=[".txt",".tsv"],n=t.name.toLowerCase();return e.some(r=>n.endsWith(r))}function j(t,e){t.addEventListener("change",async n=>{let s=n.target.files?.[0];if(s){let o=await Le(s);o.filename=s.name,e(o)}})}function W(t){t.click()}function U(t){let e=[];return Number.isInteger(t)?t<1?e.push({field:"replicaCount",message:"Replica count must be at least 1"}):t>10&&e.push({field:"replicaCount",message:"Replica count cannot exceed 10"}):e.push({field:"replicaCount",message:"Replica count must be a whole number"}),{isValid:e.length===0,errors:e}}function J(t,e){let n=[];return!t||t.trim()===""?n.push({field:"housekeeper",message:"Please select a housekeeper gene"}):e.includes(t)||n.push({field:"housekeeper",message:`"${t}" is not a valid gene in the data`}),{isValid:n.length===0,errors:n}}function K(t,e,n){let r=[];t.length===0&&r.push({field:"sampleList",message:"Please enter at least one sample name"}),new Set(t).size!==t.length&&r.push({field:"sampleList",message:"Duplicate sample names found"});let o=Math.floor(e/n);return t.length>o&&r.push({field:"sampleList",message:`Too many samples. Data supports ${o} samples with ${n} replicas each`}),{isValid:r.length===0,errors:r}}function Q(t,e){let n=[];t.length===0&&n.push({field:"controlList",message:"Please enter at least one control sample"});let r=t.filter(o=>!e.includes(o));return r.length>0&&n.push({field:"controlList",message:`Invalid control(s): ${r.join(", ")}. Controls must be in the sample list.`}),new Set(t).size!==t.length&&n.push({field:"controlList",message:"Duplicate control names found"}),{isValid:n.length===0,errors:n}}function D(t,e,n="Sample"){let r=Math.floor(t/e),s=[];for(let o=1;o<=r;o++)s.push(`${n} ${o}`);return s}function b(t){return t.length===0?0:t.reduce((n,r)=>n+r,0)/t.length}function G(t){if(t.length<2)return 0;let e=b(t),r=t.map(s=>Math.pow(s-e,2)).reduce((s,o)=>s+o,0)/(t.length-1);return Math.sqrt(r)}function X(t,e){return Math.sqrt(Math.pow(t,2)+Math.pow(e,2))}function Y(t,e,n){return e+n===0?0:t/Math.sqrt((e+n)/2)}function Z(t){return Math.pow(2,-t)}function _(t,e=2){let n=Math.pow(10,e);return Math.round(t*n)/n}function u(t,e=2){return isNaN(t)||!isFinite(t)?"-":t.toFixed(e)}function Ie(t){let e=[];for(let n of t.normalizedRows){let r=n.controlName?u(n.normalizedControl,4):"",s=n.observedName?u(n.normalizedObserved,4):"";e.push(`${r}	${s}`)}return e.join(`
`)}async function $e(t){try{return navigator.clipboard&&navigator.clipboard.writeText?(await navigator.clipboard.writeText(t),!0):He(t)}catch(e){return console.error("Failed to copy to clipboard:",e),!1}}function He(t){let e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.select();try{let n=document.execCommand("copy");return document.body.removeChild(e),n}catch{return document.body.removeChild(e),!1}}async function ee(t){let e=Ie(t);return $e(e)}function Fe(t,e,n){let r=[],s=n.filter(i=>!e.includes(i)),o=Math.min(s.length,e.length),a=s.slice(0,o),l=Math.max(e.length,a.length);for(let i=0;i<l;i++){let d=e[i]??"",m=a[i]??"",g=t.rows.find(h=>!h.isReplicaRow&&h.sampleName===d),C=t.rows.find(h=>!h.isReplicaRow&&h.sampleName===m);r.push({controlName:d,controlFoldChange:g?.foldChange??0,observedName:m,observedFoldChange:C?.foldChange??0})}return r}function Oe(t){let e=t.filter(n=>n.controlName&&n.controlFoldChange>0).map(n=>n.controlFoldChange);return e.length>0?b(e):1}function Be(t,e){return e===0&&(e=1),t.map(n=>({controlName:n.controlName,normalizedControl:n.controlFoldChange/e,observedName:n.observedName,normalizedObserved:n.observedFoldChange/e}))}function Ae(t,e,n){let r=Fe(t,e,n),s=Oe(r),o=Be(r,s);return{geneName:t.geneName,foldChangeRows:r,controlAverage:_(s,4),normalizedRows:o}}function te(t,e,n){let r=new Map;for(let[s,o]of t){let a=Ae(o,e,n);r.set(s,a)}return r}function ze(t){let e=new Map,n=q(t);if(!n)throw new Error("Could not detect CT value column");return t.rows.forEach((r,s)=>{if(R(r))return;let o=r.Name;if(!o)return;let a=parseFloat(r[n]);if(isNaN(a))return;e.has(o)||e.set(o,{name:o,measurements:[],replicaGroups:[]}),e.get(o).measurements.push({value:a,rowIndex:s})}),e}function qe(t,e,n){let r=[];for(let s=0;s<n.length;s++){let o=s*e,a=o+e;if(a>t.length)break;let l=t.slice(o,a).map(i=>i.value);r.push({sampleName:n[s],sampleNumber:s+1,ctValues:l})}return r}function ne(t,e,n){let r=ze(t);for(let[s,o]of r)o.replicaGroups=qe(o.measurements,e,n);return r}function je(t,e,n){let r=[],{replicaCount:s}=n,o=[];for(let l=0;l<t.replicaGroups.length;l++){let i=t.replicaGroups[l],d=e.replicaGroups[l];if(!i||!d)continue;let m=b(i.ctValues),g=b(d.ctValues),C=m-g;o.push(C)}let a=o.length>0?o[0]:0;for(let l=0;l<t.replicaGroups.length;l++){let i=t.replicaGroups[l],d=e.replicaGroups[l];if(!i||!d)continue;let m=b(i.ctValues),g=G(i.ctValues),C=b(d.ctValues),h=G(d.ctValues),I=m-C,$=I-a,H=X(g,h),xe=Y(H,s,s),Ee=Z($);r.push({sampleNumber:i.sampleNumber,sampleName:i.sampleName,ctValues:i.ctValues,ctStd:g,ctMean:m,hkCtValues:d.ctValues,hkCtStd:h,hkCtMean:C,deltaCt:I,deltaDeltaCt:$,combinedStd:H,foldChange:Ee,sem:xe,isReplicaRow:!1});for(let T=0;T<s;T++)T<i.ctValues.length&&r.push({sampleNumber:i.sampleNumber,sampleName:i.sampleName,ctValues:[i.ctValues[T]],ctStd:0,ctMean:0,hkCtValues:[d.ctValues[T]??0],hkCtStd:0,hkCtMean:0,deltaCt:0,deltaDeltaCt:0,combinedStd:0,foldChange:0,sem:0,isReplicaRow:!0,replicaIndex:T})}return r}function We(t,e,n){let r=je(t,e,n),o=r.find(a=>!a.isReplicaRow)?.deltaCt??0;return{geneName:t.name,rows:r,firstDeltaCt:o}}function re(t,e,n){let r=new Map,s=t.get(e);if(!s)throw new Error(`Housekeeper gene "${e}" not found`);for(let[o,a]of t){if(o===e)continue;let l=We(a,s,n);r.set(o,l)}return r}function Ue(t,e){return t.map(n=>`<button class="tab-btn${n.id===e?" active":""}" data-tab-id="${n.id}">${n.label}</button>`).join("")}function Je(t,e){return t.map(n=>`<div class="tab-panel${n.id===e?" active":""}" data-tab-panel="${n.id}">${n.content}</div>`).join("")}function se(t,e,n){let r=document.getElementById(t);r&&r.addEventListener("click",s=>{let a=s.target.dataset.tabId;a&&n(a)})}function oe(t,e,n){let r=document.getElementById(e),s=document.getElementById(n);!r||!s||(r.querySelectorAll(".tab-btn").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-tab-id")===t)}),s.querySelectorAll(".tab-panel").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-tab-panel")===t)}))}function ae(t,e,n,r){let s=document.getElementById(n),o=document.getElementById(r);if(!s||!o)return;let a=e??t[0]?.id??null;s.innerHTML=Ue(t,a),o.innerHTML=Je(t,a)}function ie(t,e,n){return t.map(r=>{let s=r.value===e,o=s?" selected":"",a=s?" checked":"";return`
      <label class="radio-option${o}">
        <input type="radio" name="${n}" value="${r.value}"${a}>
        <span>${r.label}</span>
      </label>
    `}).join("")}function le(t,e){let n=document.getElementById(t);n&&n.addEventListener("change",r=>{let s=r.target;if(s.type==="radio"){n.querySelectorAll(".radio-option").forEach(a=>{a.classList.remove("selected")});let o=s.closest(".radio-option");o&&o.classList.add("selected"),e(s.value)}})}function N(t){let{headers:e,rows:n,className:r="data-table",headerClassName:s="",cellRenderer:o}=t,a=`<table class="${r}">`;return a+="<thead><tr>",e.forEach(l=>{a+=`<th class="${s}">${p(l)}</th>`}),a+="</tr></thead>",a+="<tbody>",n.forEach((l,i)=>{a+="<tr>",Array.isArray(l)?l.forEach((d,m)=>{let g=o?o(d,e[m],i):p(d);a+=`<td>${g}</td>`}):e.forEach(d=>{let m=l[d]??"",g=o?o(m,d,i):p(m);a+=`<td>${g}</td>`}),a+="</tr>"}),a+="</tbody>",a+="</table>",a}function p(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}function ce(t){let e=document.getElementById("input-table-container");if(!e)return;let n=w(t),r=N({headers:n.headers,rows:n.rows,className:"data-table"});e.innerHTML=r}function M(t){let e=document.getElementById("loaded-filename");e&&(e.textContent=t?`Loaded: ${t}`:"")}function ue(t){let e=document.getElementById("status-warnings");if(!e)return;let n=z(t);if(n.length===0){e.innerHTML="";return}let r='<div class="warnings-header">Status Warnings:</div>';r+='<ul class="warning-list">';for(let s of n)r+=`<li class="warning-item">${p(s)}</li>`;r+="</ul>",e.innerHTML=r}function de(t){let e=document.getElementById("page-title");e&&(e.textContent=t),document.title=t}function pe(t,e){let n=document.getElementById("housekeeper-picker");if(!n)return;let r=t.map(s=>({value:s,label:s}));n.innerHTML=ie(r,e,"housekeeper")}function me(t,e){let n=document.getElementById("housekeeper-table-container");if(!n)return;if(!e){n.innerHTML='<p class="text-center">Select a housekeeper gene to view its data</p>';return}let r=A(t,e),s=N({headers:t.headers,rows:r,className:"data-table"});n.innerHTML=s}function ge(t){le("housekeeper-picker",t)}function P(t){let e=document.getElementById("sample-list");e&&(e.value=t.join(`
`))}function fe(){let t=document.getElementById("sample-list");return t?t.value.trimEnd().split(`
`).map(e=>e.trim()).filter(e=>e.length>0):[]}function he(){let t=document.getElementById("control-list");return t?t.value.trimEnd().split(`
`).map(e=>e.trim()).filter(e=>e.length>0):[]}function L(){let t=document.getElementById("replica-count");return t&&parseInt(t.value,10)||3}function f(t,e){let n=document.getElementById(t);n&&(n.textContent=e,n.classList.remove("hidden"))}function v(t){let e=document.getElementById(t);e&&(e.textContent="")}function be(t){v("file-error"),v("replica-error"),v("housekeeper-error"),v("sample-list-error"),v("control-list-error"),t.forEach((e,n)=>{switch(n){case"file":f("file-error",e);break;case"replicaCount":f("replica-error",e);break;case"housekeeper":f("housekeeper-error",e);break;case"sampleList":f("sample-list-error",e);break;case"controlList":f("control-list-error",e);break}})}var y=new Map;function ve(t){let e=document.getElementById("output-container");if(!e)return;if(t.size===0){e.innerHTML='<p class="text-center">Complete the processing step to see normalized output values.</p>';return}let n="";for(let[r,s]of t)n+=Ke(s);e.innerHTML=n,Ye(t)}function Ke(t){let e=`<div class="output-gene-column" data-gene="${p(t.geneName)}">`;e+=`<h3>${p(t.geneName)}</h3>`,e+=Qe(t),e+=Xe(t);let n=y.get(t.geneName)||0;return e+=`
    <div class="copy-btn-container">
      <button class="btn btn-success copy-btn" data-gene="${p(t.geneName)}">
        Copy to Clipboard
      </button>
      <div class="copy-counter" data-gene="${p(t.geneName)}">
        Copied ${n} time${n!==1?"s":""}
      </div>
    </div>
  `,e+="</div>",e}function Qe(t){let e='<div class="output-table-section">';e+="<h4>2\u207B\u0394\u0394CT values</h4>",e+='<table class="data-table output-table">',e+="<thead>",e+="<tr><th>Control</th><th>Control</th><th>Observed</th><th>Observed</th></tr>",e+="<tr><th>Sample</th><th>2\u207B\u0394\u0394CT</th><th>Sample</th><th>2\u207B\u0394\u0394CT</th></tr>",e+="</thead><tbody>";for(let n of t.foldChangeRows)e+="<tr>",e+=`<td>${p(n.controlName)}</td>`,e+=`<td class="numeric">${n.controlName?u(n.controlFoldChange,4):""}</td>`,e+=`<td>${p(n.observedName)}</td>`,e+=`<td class="numeric">${n.observedName?u(n.observedFoldChange,4):""}</td>`,e+="</tr>";return e+='<tr class="bold totals-row">',e+='<td class="bold">Average:</td>',e+=`<td class="numeric bold">${u(t.controlAverage,4)}</td>`,e+="<td></td><td></td>",e+="</tr>",e+="</tbody></table>",e+="</div>",e}function Xe(t){let e='<div class="output-table-section">';e+="<h4>Normalized 2\u207B\u0394\u0394CT values</h4>",e+='<table class="data-table output-table">',e+="<thead>",e+="<tr><th>Control</th><th>norm Control</th><th>Observed</th><th>norm Observed</th></tr>",e+="<tr><th>Sample</th><th>2\u207B\u0394\u0394CT</th><th>Sample</th><th>2\u207B\u0394\u0394CT</th></tr>",e+="</thead><tbody>";for(let n of t.normalizedRows)e+="<tr>",e+=`<td>${p(n.controlName)}</td>`,e+=`<td class="numeric">${n.controlName?u(n.normalizedControl,4):""}</td>`,e+=`<td>${p(n.observedName)}</td>`,e+=`<td class="numeric">${n.observedName?u(n.normalizedObserved,4):""}</td>`,e+="</tr>";return e+="</tbody></table>",e+="</div>",e}function Ye(t){let e=document.getElementById("output-container");e&&e.addEventListener("click",async n=>{let r=n.target;if(r.classList.contains("copy-btn")){let s=r.dataset.gene;if(s&&t.has(s)){let o=t.get(s);if(await ee(o)){let l=y.get(s)||0;y.set(s,l+1);let i=e.querySelector(`.copy-counter[data-gene="${s}"]`);if(i){let m=l+1;i.textContent=`Copied ${m} time${m!==1?"s":""}`}let d=r.textContent;r.textContent="Copied!",r.classList.add("copy-success"),setTimeout(()=>{r.textContent=d,r.classList.remove("copy-success")},1500)}else r.textContent="Copy failed",setTimeout(()=>{r.textContent="Copy to Clipboard"},1500)}}})}function x(){let t=document.getElementById("output-container");t&&(t.innerHTML='<p class="text-center">Complete the processing step to see normalized output values.</p>'),y.clear(),Ze()}function Ce(t){let e=document.getElementById("ignored-genes");if(!e)return;if(t.length===0){e.innerHTML="";return}let n='<div class="ignored-genes-header">Genes excluded from output (no normalized tables):</div>';n+='<ul class="ignored-genes-list">';for(let r of t)n+=`<li class="ignored-gene-item">${p(r)}</li>`;n+="</ul>",e.innerHTML=n}function Ze(){let t=document.getElementById("ignored-genes");t&&(t.innerHTML="")}function Te(t,e){if(t.size===0){let r=document.getElementById("processing-content");r&&(r.innerHTML='<p class="text-center">Configure input settings and select a housekeeper gene to see processing results.</p>');return}let n=[];for(let[r,s]of t)n.push({id:r,label:r,content:_e(s)});ae(n,e,"gene-tabs","processing-content")}function _e(t){let e=["SAMPLE NR","SAMPLE","CT","STD","[CT]","","H CT","H STD","H [CT]","","\u0394CT","\u0394\u0394CT","Combined STD","","2\u207B\u0394\u0394CT","SEM"],n=["sample-header","sample-header","sample-header","sample-header","sample-header","","housekeeper-header","housekeeper-header","housekeeper-header","","calc-header","calc-header","calc-header","","result-header","result-header"],r='<div class="table-container scrollable" style="max-height: 500px;">';r+='<table class="data-table processing-table">',r+="<thead><tr>",e.forEach((s,o)=>{r+=`<th class="${n[o]}">${p(s)}</th>`}),r+="</tr></thead>",r+="<tbody>";for(let s of t.rows)r+=et(s);return r+="</tbody></table></div>",r}function et(t){return t.isReplicaRow?`
      <tr class="replica-row">
        <td></td>
        <td></td>
        <td class="numeric">${u(t.ctValues[0],2)}</td>
        <td></td>
        <td></td>
        <td></td>
        <td class="numeric">${u(t.hkCtValues[0],2)}</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    `:`
    <tr class="sample-row">
      <td class="numeric bold">${t.sampleNumber}</td>
      <td class="bold">${p(t.sampleName)}</td>
      <td class="numeric">${u(t.ctValues[0],2)}</td>
      <td class="numeric">${u(t.ctStd,2)}</td>
      <td class="numeric">${u(t.ctMean,2)}</td>
      <td></td>
      <td class="numeric">${u(t.hkCtValues[0],2)}</td>
      <td class="numeric">${u(t.hkCtStd,2)}</td>
      <td class="numeric">${u(t.hkCtMean,2)}</td>
      <td></td>
      <td class="numeric">${u(t.deltaCt,2)}</td>
      <td class="numeric">${u(t.deltaDeltaCt,2)}</td>
      <td class="numeric">${u(t.combinedStd,2)}</td>
      <td></td>
      <td class="numeric">${u(t.foldChange,2)}</td>
      <td class="numeric">${u(t.sem,2)}</td>
    </tr>
  `}function Re(t){se("gene-tabs","processing-content",t)}function k(){let t=document.getElementById("gene-tabs"),e=document.getElementById("processing-content");t&&(t.innerHTML=""),e&&(e.innerHTML='<p class="text-center">Configure input settings and select a housekeeper gene to see processing results.</p>')}function we(){return{rawData:null,config:{replicaCount:3,housekeeper:"",samples:[],controls:[]},availableGenes:[],geneDataMap:new Map,processingResults:new Map,outputResults:new Map,activeGeneTab:null,validationErrors:[]}}var V=class{constructor(){this.state=we(),this.subscribers=new Set}getState(){return this.state}subscribe(e){return this.subscribers.add(e),()=>this.subscribers.delete(e)}notify(e){this.subscribers.forEach(n=>{try{n(e,this.state)}catch(r){console.error("State subscriber error:",r)}})}setRawData(e,n){this.state.rawData=e,this.state.availableGenes=n,this.state.geneDataMap.clear(),this.state.processingResults.clear(),this.state.outputResults.clear(),this.state.validationErrors=[],this.notify({type:"data-loaded",payload:e})}setReplicaCount(e){this.state.config.replicaCount=e,this.notify({type:"config-changed",payload:{replicaCount:e}})}setHousekeeper(e){this.state.config.housekeeper=e,this.state.processingResults.clear(),this.state.outputResults.clear(),this.notify({type:"housekeeper-changed",payload:e})}setSamples(e){this.state.config.samples=e,this.state.processingResults.clear(),this.state.outputResults.clear(),this.notify({type:"samples-changed",payload:e})}setControls(e){this.state.config.controls=e,this.state.outputResults.clear(),this.notify({type:"samples-changed",payload:e})}setGeneDataMap(e){this.state.geneDataMap=e}setProcessingResults(e){this.state.processingResults=e,!this.state.activeGeneTab&&e.size>0&&(this.state.activeGeneTab=Array.from(e.keys())[0]),this.notify({type:"processing-complete",payload:e})}setOutputResults(e){this.state.outputResults=e,this.notify({type:"output-complete",payload:e})}setActiveGeneTab(e){this.state.activeGeneTab=e,this.notify({type:"tab-changed",payload:e})}setValidationErrors(e){this.state.validationErrors=e,this.notify({type:"validation-error",payload:e})}clearValidationError(e){this.state.validationErrors=this.state.validationErrors.filter(n=>n.field!==e)}addValidationError(e){this.clearValidationError(e.field),this.state.validationErrors.push(e),this.notify({type:"validation-error",payload:this.state.validationErrors})}reset(){this.state=we(),this.notify({type:"data-loaded",payload:null})}},c=new V;var ye=t=>c.subscribe(t);var E=class{constructor(){this.debounceTimer=null;this.init()}init(){this.setupEventListeners(),this.setupStateSubscription(),console.log("Gene Expression Analysis App initialized")}setupEventListeners(){let e=document.getElementById("upload-btn"),n=document.getElementById("file-input");e&&n&&(e.addEventListener("click",()=>W(n)),j(n,this.handleFileProcessed.bind(this)));let r=document.getElementById("replica-count");r&&r.addEventListener("change",this.handleReplicaCountChange.bind(this)),ge(this.handleHousekeeperChange.bind(this));let s=document.getElementById("sample-list");s&&s.addEventListener("input",this.debounce(this.handleSampleListChange.bind(this),500));let o=document.getElementById("control-list");o&&o.addEventListener("input",this.debounce(this.handleControlListChange.bind(this),500)),Re(this.handleTabChange.bind(this))}setupStateSubscription(){ye((e,n)=>{switch(e.type){case"data-loaded":n.rawData&&this.onDataLoaded(n.rawData);break;case"housekeeper-changed":n.rawData&&me(n.rawData,n.config.housekeeper),this.runProcessing();break;case"samples-changed":this.runProcessing();break;case"processing-complete":Te(n.processingResults,n.activeGeneTab),this.runOutput();break;case"output-complete":ve(n.outputResults);let r=Array.from(n.outputResults.keys()),s=n.availableGenes.filter(o=>!r.includes(o)&&o!==n.config.housekeeper);Ce(s);break;case"tab-changed":n.activeGeneTab&&oe(n.activeGeneTab,"gene-tabs","processing-content");break;case"validation-error":this.displayErrors(n.validationErrors);break}})}handleFileProcessed(e){if(!e.success||!e.data){f("file-error",e.error??"Failed to process file"),M("");return}v("file-error"),M(e.filename??"");let n=B(e.data);c.setRawData(e.data,n)}onDataLoaded(e){let n=c.getState();de(e.title),ce(e),ue(e),pe(n.availableGenes,n.config.housekeeper);let s=w(e).rows.filter(l=>l.Name===n.availableGenes[0]).length,o=L(),a=D(s,o);P(a),c.setSamples(a),k(),x()}handleReplicaCountChange(){let e=L(),n=U(e);if(!n.isValid){c.setValidationErrors(n.errors);return}c.clearValidationError("replicaCount"),c.setReplicaCount(e);let r=c.getState();if(r.rawData&&r.availableGenes.length>0){let s=r.rawData.rows.filter(a=>a.Name===r.availableGenes[0]).length,o=D(s,e);P(o),c.setSamples(o)}}handleHousekeeperChange(e){let n=c.getState(),r=J(e,n.availableGenes);if(!r.isValid){c.setValidationErrors(r.errors);return}c.clearValidationError("housekeeper"),c.setHousekeeper(e)}handleSampleListChange(){let e=fe(),n=c.getState();if(!n.rawData)return;let r=n.rawData.rows.filter(o=>o.Name===n.availableGenes[0]).length,s=K(e,r,n.config.replicaCount);if(!s.isValid){c.setValidationErrors(s.errors);return}c.clearValidationError("sampleList"),c.setSamples(e)}handleControlListChange(){let e=he(),n=c.getState(),r=Q(e,n.config.samples);if(!r.isValid){c.setValidationErrors(r.errors);return}c.clearValidationError("controlList"),c.setControls(e)}handleTabChange(e){c.setActiveGeneTab(e)}runProcessing(){let e=c.getState();if(!e.rawData||!e.config.housekeeper||e.config.samples.length===0){k(),x();return}try{let n=ne(e.rawData,e.config.replicaCount,e.config.samples);c.setGeneDataMap(n);let r=re(n,e.config.housekeeper,e.config);c.setProcessingResults(r)}catch(n){console.error("Processing error:",n),f("processing-error",n instanceof Error?n.message:"Processing failed")}}runOutput(){let e=c.getState();if(e.processingResults.size===0||e.config.controls.length===0){x();return}try{let n=te(e.processingResults,e.config.controls,e.config.samples);c.setOutputResults(n)}catch(n){console.error("Output generation error:",n),f("output-error",n instanceof Error?n.message:"Output generation failed")}}displayErrors(e){let n=new Map;e.forEach(r=>{n.set(r.field,r.message)}),be(n)}debounce(e,n){return(...r)=>{this.debounceTimer!==null&&window.clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{e.apply(this,r),this.debounceTimer=null},n)}}};document.addEventListener("DOMContentLoaded",()=>{new E});return Pe(tt);})();
